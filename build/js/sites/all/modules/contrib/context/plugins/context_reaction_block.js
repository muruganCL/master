!function(t){Drupal.behaviors.contextReactionBlock={attach:function(e){t("form.context-editor:not(.context-block-processed)").addClass("context-block-processed").each(function(){var e=t(this).attr("id");Drupal.contextBlockEditor=Drupal.contextBlockEditor||{},t(this).bind("init.pageEditor",function(o){Drupal.contextBlockEditor[e]=new DrupalContextBlockEditor(t(this))}),t(this).bind("start.pageEditor",function(o,i){i||(i=t(this).data("defaultContext")),Drupal.contextBlockEditor[e].editStart(t(this),i)}),t(this).bind("end.pageEditor",function(t){Drupal.contextBlockEditor[e].editFinish()})}),t("#context-blockform:not(.processed)").each(function(){t(this).addClass("processed"),Drupal.contextBlockForm=new DrupalContextBlockForm(t(this)),Drupal.contextBlockForm.setState()}),t("#context-blockform a.remove:not(.processed)").each(function(){t(this).addClass("processed"),t(this).click(function(){return t(this).parents("tr").eq(0).remove(),Drupal.contextBlockForm.setState(),!1})}),t("div.context-block-browser",e).nextAll(".form-item").hide()}},DrupalContextBlockForm=function(e){this.state={},this.setState=function(){t("table.context-blockform-region",e).each(function(){var e=t(this).attr("id").split("context-blockform-region-")[1],o=[];t("tr",t(this)).each(function(){var e=t(this).attr("id"),i=t(this).find("select,input").first().val();o.push({bid:e,weight:i})}),Drupal.contextBlockForm.state[e]=o}),t("form input.context-blockform-state").val(JSON.stringify(this.state)),t("table.context-blockform-region tr").each(function(){var e=t(this).attr("id");t("div.context-blockform-selector input[value="+e+"]").parents("div.form-item").eq(0).hide()}),t("div.context-blockform-selector input").each(function(){var e=t(this).val();0===t("table.context-blockform-region tr#"+e).size()&&t(this).parents("div.form-item").eq(0).show()})},t("#ctools-export-ui-edit-item-form").submit(function(){Drupal.contextBlockForm.setState()}),t.each(Drupal.settings.tableDrag,function(o){var i=t("#"+o+":not(.processed)",e);i&&i.is(".context-blockform-region")&&(i.addClass("processed"),i.bind("mouseup",function(t){Drupal.contextBlockForm.setState()}))}),t("td.blocks a",e).each(function(){t(this).click(function(){var e=t(this).attr("href").split("#")[1],o="context-blockform-region-"+e,i=t("div.context-blockform-selector input:checked");if(i.size()>0){var s=!1,c=-10,a=10,n=c-1;t("table#"+o+" tr").each(function(){var e=t(this).find("select,input").first().val();+e>+n&&(n=e)}),i.each(function(){var e,i=document.createElement("tr"),r=t(this).parents("div.form-item").eq(0).hide().children("label").text(),l='<div class="form-item form-type-select"><select class="tabledrag-hide form-select">';s=!0;var d=a;for(a>=1+ +n&&(d=++n,s=!1),e=c;a>=e;++e)l+="<option",e==d&&(l+=" selected=selected"),l+=">"+e+"</option>";l+="</select></div>",t(i).attr("id",t(this).attr("value")).addClass("draggable"),t(i).html("<td>"+r+"</td><td>"+l+"</td><td><a href='' class='remove'>X</a></td>"),Drupal.tableDrag[o].makeDraggable(i),t("table#"+o).append(i),1==t.cookie("Drupal.tableDrag.showWeight")?(t("table#"+o).find(".tabledrag-hide").css("display",""),t("table#"+o).find(".tabledrag-handle").css("display","none")):(t("table#"+o).find(".tabledrag-hide").css("display","none"),t("table#"+o).find(".tabledrag-handle").css("display","")),Drupal.attachBehaviors(t("table#"+o)),Drupal.contextBlockForm.setState(),t(this).removeAttr("checked")}),s&&alert(Drupal.t("Desired block weight exceeds available weight options, please check weights for blocks before saving"))}return!1})})},DrupalContextBlockEditor=function(t){return this.editor=t,this.state={},this.blocks={},this.regions={},this},DrupalContextBlockEditor.prototype={initBlocks:function(e){var o=this;this.blocks=e,e.each(function(){t(this).hasClass("context-block-empty")&&t(this).removeClass("context-block-hidden"),t(this).addClass("draggable"),t(this).prepend(t('<a class="context-block-handle"></a>')),t(this).prepend(t('<a class="context-block-remove"></a>').click(function(){return t(this).parent(".block").eq(0).fadeOut("medium",function(){t(this).remove(),o.updateBlocks()}),!1}))})},initRegions:function(e){this.regions=e;var o=this;t(e).not(".context-ui-processed").each(function(e,i){t(".context-ui-add-link",i).click(function(e){o.showBlockBrowser(t(this).parent())}).addClass("context-ui-processed")}),t(".context-block-browser").hide()},showBlockBrowser:function(e){var o=t(".context-editing",this.editor).attr("id").replace("-trigger",""),i=t("#"+o)[0];if(this.browser=t(".context-block-browser",i).addClass("active"),!this.browser.has("input.filter").size()){var s=t(".block-browser-sidebar .filter",this.browser),c=t(".blocks",this.browser);new Drupal.Filter(c,!1,".context-block-addable",s)}this.browser.show().dialog({modal:!0,close:function(){t(this).dialog("destroy"),t(".category",this).show(),t(this).hide().appendTo(i).removeClass("active")},height:.8*t(window).height(),minHeight:400,minWidth:680,width:680}),t(".context-block-browser-categories",this.browser).change(function(e){0==t(this).val()?t(".category",a.browser).show():(t(".category",a.browser).hide(),t(".category-"+t(this).val(),a.browser).show())}),this.addToRegion&&t(".context-block-addable",this.browser).unbind("click.addToRegion");var a=this;this.addToRegion=function(i){var s={item:t(this).clone(),sender:t(e)};t(this).parents(".context-block-browser.active").dialog("close"),t(e).after(s.item),a.addBlock(i,s,this.editor,o.replace("context-editable-",""))},t(".context-block-addable",this.browser).bind("click.addToRegion",this.addToRegion)},updateBlocks:function(){var e=t("div.context-block-browser");t(".block, .admin-block").each(function(){t(this).attr("id").split("block-")[1]}),t(".context-block-item",e).each(function(){t(this).attr("id").split("context-block-addable-")[1]}),t(this.regions).each(function(){t(".block:has(a.context-block)",this).size()>0?t(this).removeClass("context-block-region-empty"):t(this).addClass("context-block-region-empty")})},updateRegion:function(e,o,i,s){switch(s){case"over":t(i).removeClass("context-block-region-empty");break;case"out":1===t(".draggable-placeholder",i).size()&&0==t(".block:has(a.context-block)",i).size()&&t(i).addClass("context-block-region-empty")}},scriptFix:function(e,o,i,s){if(t("script",o.item)){var c=t(Drupal.settings.contextBlockEditor.scriptPlaceholder),a=t("div.handle label",o.item).text();c.children("strong").html(a),t("script",o.item).parent().empty().append(c)}},addBlock:function(e,o,i,s){var c=this;if(o.item.is(".context-block-addable")){var a=o.item.attr("id").split("context-block-addable-")[1],n=Drupal.settings.contextBlockEditor.params;n.context_block=a+","+s;var r=t('<div class="context-block-item context-block-loading"><span class="icon"></span></div>');o.item.addClass("context-block-added"),o.item.after(r),t.getJSON(Drupal.settings.contextBlockEditor.path,n,function(e){if(e.status){var o=t(e.block);t("script",o)&&t("script",o).remove(),r.fadeOut(function(){t(this).replaceWith(o),c.initBlocks(o),c.updateBlocks(),Drupal.attachBehaviors(o)})}else r.fadeOut(function(){t(this).remove()})})}else o.item.is(":has(a.context-block)")&&c.updateBlocks()},setState:function(){var e=this;t(this.regions).each(function(){var o=t(".context-block-region",this).attr("id").split("context-block-region-")[1],i=[];t("a.context-block",t(this)).each(function(){if(-1!=t(this).attr("class").indexOf("edit-")){var e=t(this).attr("id").split("context-block-")[1],o=t(this).attr("class").split("edit-")[1].split(" ")[0];o=o?o:0;var s={bid:e,context:o};i.push(s)}}),e.state[o]=i}),t("input.context-block-editor-state",this.editor).val(JSON.stringify(this.state))},disableTextSelect:function(){t.browser.safari?t(".block:has(a.context-block):not(:has(input,textarea))").css("WebkitUserSelect","none"):t.browser.mozilla?t(".block:has(a.context-block):not(:has(input,textarea))").css("MozUserSelect","none"):t.browser.msie?t(".block:has(a.context-block):not(:has(input,textarea))").bind("selectstart.contextBlockEditor",function(){return!1}):t(this).bind("mousedown.contextBlockEditor",function(){return!1})},enableTextSelect:function(){t.browser.safari?t("*").css("WebkitUserSelect",""):t.browser.mozilla?t("*").css("MozUserSelect",""):t.browser.msie?t("*").unbind("selectstart.contextBlockEditor"):t(this).unbind("mousedown.contextBlockEditor")},editStart:function(e,o){var i=this;t(document.body).addClass("context-editing"),this.editor.addClass("context-editing"),this.disableTextSelect(),this.initBlocks(t(".block:has(a.context-block.edit-"+o+")")),this.initRegions(t(".context-block-region").parent()),this.updateBlocks(),t("a.context_ui_dialog-stop").hide(),t(".editing-context-label").remove();var s=t("#context-editable-trigger-"+o+" .label").text();s=Drupal.t("Now Editing: ")+s,e.parent().parent().prepend('<div class="editing-context-label">'+s+"</div>"),t(this.regions).each(function(){var s=t(this),c={revert:!0,dropOnEmpty:!0,placeholder:"draggable-placeholder",forcePlaceholderSize:!0,items:"> *:has(a.context-block.editable)",handle:"a.context-block-handle",start:function(t,s){i.scriptFix(t,s,e,o)},stop:function(t,s){i.addBlock(t,s,e,o)},receive:function(t,s){i.addBlock(t,s,e,o)},over:function(t,e){i.updateRegion(t,e,s,"over")},out:function(t,e){i.updateRegion(t,e,s,"out")},cursorAt:{left:300,top:0}};s.sortable(c)}),t(this.regions).each(function(){t(this).sortable("option","connectWith",[".ui-sortable"])}),"1.6"===t.ui.version&&t.browser.safari&&(t.browser.mozilla=!0)},editFinish:function(){this.editor.removeClass("context-editing"),this.enableTextSelect(),t(".editing-context-label").remove(),t(this.blocks).each(function(){t("a.context-block-handle, a.context-block-remove",this).remove(),t(this).hasClass("context-block-empty")&&t(this).addClass("context-block-hidden"),t(this).removeClass("draggable")}),t("a.context_ui_dialog-stop").show(),this.regions.sortable("destroy"),this.setState(),"1.6"===t.ui.version&&t.browser.safari&&(t.browser.mozilla=!1)}}}(jQuery);