!function(e){Drupal.media=Drupal.media||{},Drupal.media.filter={replaceTokenWithPlaceholder:function(e){Drupal.media.filter.ensure_tagmap();var a=e.match(/\[\[.*?\]\]/g);if(a)for(var t=0;t<a.length;t++){var r=a[t];if(-1!=r.indexOf('"type":"media"')){var i=Drupal.settings.tagmap[r],n=r.replace("[[","").replace("]]","");try{var u=JSON.parse(n)}catch(l){return e}if(!i&&u.fid){Drupal.media.filter.ensureSourceMap();var p=Drupal.settings.mediaSourceMap[u.fid];i=document.createElement(p.tagName),i.src=p.src,i.innerHTML=p.innerHTML}var s=Drupal.media.filter.create_element(i,u),m=Drupal.media.filter.outerHTML(s);e=e.split(r).join(m)}}return e},replacePlaceholderWithToken:function(a){Drupal.media.filter.ensure_tagmap(),Drupal.settings.tagmap={};var t="class=['\"][^'\"]*?media-element",r="<img[^>]+"+t+"[^>]*?>";r+="|<span[^>]+"+t+"[^>]*?>[\\S\\s]+?</span>";var n=a.match(RegExp(r,"gi"));if(n)for(i=0;i<n.length;i++)markup=n[i],macro=Drupal.media.filter.create_macro(e(markup)),Drupal.settings.tagmap[macro]=markup,a=a.replace(markup,macro);return a},create_element:function(a,t){e("<div>").append(a).text().length===a.length&&(a="<span>"+a+"</span>");var r=e(a);r.is("a")&&(r=r.children()),t.attributes&&(e.each(Drupal.settings.media.wysiwyg_allowed_attributes,function(e,a){t.attributes[a]&&r.attr(a,t.attributes[a])}),delete t.attributes,Drupal.media.filter.ensureSourceMap(),Drupal.settings.mediaSourceMap[t.fid]={tagName:r[0].tagName,src:r[0].src,innerHTML:r[0].innerHTML}),t.type=t.type||"media",Drupal.media.filter.ensureDataMap(),Drupal.settings.mediaDataMap[t.fid]=t,r.attr("data-fid",t.fid),r.attr("data-media-element","1");var i=["media-element"];return t.view_mode&&i.push("file-"+t.view_mode.replace(/_/g,"-")),r.addClass(i.join(" ")),t.link_text&&e("a",r).html(t.link_text),r},create_macro:function(e){var a=Drupal.media.filter.extract_file_info(e);return a?("string"==typeof a.link_text&&(a.link_text=a.link_text.replace(/</g,"&lt;").replace(/>/g,"&gt;")),"[["+JSON.stringify(a)+"]]"):!1},extract_file_info:function(a){var t,r,i;return(t=a.data("fid"))&&(Drupal.media.filter.ensureDataMap(),(r=Drupal.settings.mediaDataMap[t])&&(r.attributes={},e.each(Drupal.settings.media.wysiwyg_allowed_attributes,function(e,t){(i=a.attr(t))&&("string"==typeof i&&(i=i.replace("&quot;",'\\"')),r.attributes[t]=i)}),r.link_text=a.find("a").html())),r},outerHTML:function(a){return a[0].outerHTML||e("<div>").append(a.eq(0).clone()).html()},getWysiwygHTML:function(e){var a=Drupal.media.filter.outerHTML(e),t=Drupal.media.filter.create_macro(e);return Drupal.media.filter.ensure_tagmap(),Drupal.settings.tagmap[t]=a,a},ensureSourceMap:function(){return Drupal.settings.mediaSourceMap=Drupal.settings.mediaSourceMap||{},Drupal.settings.mediaSourceMap},ensureDataMap:function(){return Drupal.settings.mediaDataMap=Drupal.settings.mediaDataMap||{},Drupal.settings.mediaDataMap},ensure_tagmap:function(){return Drupal.settings.tagmap=Drupal.settings.tagmap||{},Drupal.settings.tagmap}}}(jQuery);